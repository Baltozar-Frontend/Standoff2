<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Standoff 2: Dust Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #c2b280; touch-action: none; font-family: 'Arial', sans-serif; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .stats { position: absolute; top: 20px; left: 20px; background: rgba(20,25,30,0.9); color: white; padding: 12px 20px; border-radius: 8px; border-bottom: 4px solid #ffcc00; pointer-events: auto; }
        #fire-btn { position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; background: radial-gradient(circle, #ff4444, #800); border: 5px solid #fff; border-radius: 50%; color: white; font-weight: 900; display: flex; align-items: center; justify-content: center; pointer-events: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 110px; height: 110px; background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
        #cross { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #0f0; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.7; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats">
        <b style="letter-spacing:1px;">ANDREY PRO</b><br>
        <div style="font-size:13px; margin-top:5px;">GOLD: <span style="color:#ffcc00" id="g">0</span> | KILLS: <span id="k">0</span></div>
    </div>
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="cross"></div>
    <div id="fire-btn">FIRE</div>
</div>

<script>
    let scene, camera, renderer, weapon, enemy;
    let yaw = 0, pitch = 0, moveF = 0, moveS = 0;
    let gold = 0, kills = 0, bobbing = 0;
    let particles = [];

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Небо
        scene.fog = new THREE.Fog(0xd1b07d, 5, 50); // Песчаная буря вдалеке

        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
        camera.rotation.order = 'YXZ';
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- КРАСИВЫЙ СВЕТ ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffeebb, 1.2);
        sun.position.set(20, 40, 10);
        sun.castShadow = true;
        scene.add(sun);

        // --- ОКРУЖАЮЩАЯ СРЕДА ---
        // Пол с шахматным рисунком (имитация плитки/песка)
        const groundGeo = new THREE.PlaneGeometry(200, 200);
        const groundMat = new THREE.MeshStandardMaterial({ 
            color: 0xbc9d7e, 
            roughness: 0.8,
            metalness: 0.1
        });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Добавляем "ящики" для красоты
        for(let i=0; i<15; i++) {
            const box = new THREE.Mesh(
                new THREE.BoxGeometry(2, 2, 2),
                new THREE.MeshStandardMaterial({color: 0x8b4513})
            );
            box.position.set(Math.random()*60-30, 1, Math.random()*60-30);
            box.castShadow = true;
            box.receiveShadow = true;
            scene.add(box);
        }

        loadWeapon();
        spawnEnemy();
        setupControls();
        animate();
    }

    function loadWeapon() {
        const loader = new THREE.GLTFLoader();
        loader.load('./weapon.glb', (gltf) => {
            weapon = gltf.scene;
            // ТВОИ ЛЮБИМЫЕ НАСТРОЙКИ (НЕ ТРОГАЕМ)
            weapon.position.set(0.3, -0.3, -0.45); 
            weapon.rotation.set(0, Math.PI / 2, 0); 
            weapon.scale.set(0.28, 0.28, 0.28);
            camera.add(weapon);
        });
    }

    function spawnEnemy() {
        if(enemy) scene.remove(enemy);
        const geom = new THREE.BoxGeometry(1.2, 2.2, 1.2);
        const mat = new THREE.MeshStandardMaterial({ color: 0xff4444, emissive: 0x330000 });
        enemy = new THREE.Mesh(geom, mat);
        enemy.position.set(Math.random()*40-20, 1.1, Math.random()*40-20);
        enemy.castShadow = true;
        enemy.alive = true;
        scene.add(enemy);
    }

    function createDeathEffect(pos) {
        for(let i=0; i<20; i++) {
            const p = new THREE.Mesh(
                new THREE.BoxGeometry(0.3, 0.3, 0.3),
                new THREE.MeshBasicMaterial({color: 0xff0000})
            );
            p.position.copy(pos);
            p.velocity = new THREE.Vector3((Math.random()-0.5)*0.3, Math.random()*0.3, (Math.random()-0.5)*0.3);
            p.life = 1.0;
            scene.add(p);
            particles.push(p);
        }
    }

    function shoot() {
        if(!weapon || (enemy && !enemy.alive)) return;

        weapon.position.z += 0.05;
        setTimeout(() => weapon.position.z -= 0.05, 50);

        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = ray.intersectObject(enemy);

        if(hits.length > 0) {
            enemy.alive = false;
            createDeathEffect(enemy.position);
            scene.remove(enemy);
            kills++; gold += 25;
            document.getElementById('k').innerText = kills;
            document.getElementById('g').innerText = gold;
            setTimeout(spawnEnemy, 1200);
        }
    }

    function setupControls() {
        let lookID = null, lx, ly;
        window.addEventListener('touchstart', e => {
            for(let t of e.changedTouches) {
                if(t.clientX > window.innerWidth/2) { lookID = t.identifier; lx = t.clientX; ly = t.clientY; }
            }
        }, {passive: false});

        window.addEventListener('touchmove', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === lookID) {
                    yaw -= (t.clientX - lx) * 0.007;
                    pitch -= (t.clientY - ly) * 0.007;
                    pitch = Math.max(-1.4, Math.min(1.4, pitch));
                    lx = t.clientX; ly = t.clientY;
                }
                if(t.clientX < window.innerWidth/2) {
                    const rect = document.getElementById('joy-base').getBoundingClientRect();
                    const dx = t.clientX - (rect.left + 55), dy = t.clientY - (rect.top + 55);
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                    const angle = Math.atan2(dy, dx);
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                    moveF = -Math.sin(angle) * (dist/40); moveS = Math.cos(angle) * (dist/40);
                }
            }
        }, {passive: false});

        window.addEventListener('touchend', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === lookID) lookID = null;
                if(t.clientX < window.innerWidth/2) {
                    moveF = 0; moveS = 0;
                    document.getElementById('joy-stick').style.transform = `translate(0,0)`;
                }
            }
        });

        document.getElementById('fire-btn').addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });
    }

    function animate() {
        requestAnimationFrame(animate);
        const s = 0.15;
        camera.translateX(moveS * s);
        camera.translateZ(-moveF * s);
        camera.position.y = 1.7; // Рост игрока
        camera.rotation.y = yaw;
        camera.rotation.x = pitch;

        // Покачивание при ходьбе
        if(weapon && (moveF !== 0 || moveS !== 0)) {
            bobbing += 0.2;
            weapon.position.y = -0.3 + Math.sin(bobbing) * 0.012;
            weapon.position.x = 0.3 + Math.cos(bobbing) * 0.005;
        }

        // Осколки врага
        for(let i=particles.length-1; i>=0; i--) {
            particles[i].position.add(particles[i].velocity);
            particles[i].life -= 0.03;
            if(particles[i].life <= 0) {
                scene.remove(particles[i]);
                particles.splice(i, 1);
            }
        }
        renderer.render(scene, camera);
    }
    init();
</script>
</body>
</html>
