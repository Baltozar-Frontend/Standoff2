<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SO2 View Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; touch-action: none; font-family: sans-serif; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .stats { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; border-left: 4px solid #ffcc00; }
        #fire-btn { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: radial-gradient(circle, #ff4444, #800); border: 4px solid #fff; border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        #cross { position: fixed; top: 50%; left: 50%; width: 10px; height: 10px; border: 2px solid #0f0; border-radius: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats">
        <b>ANDREY PRO</b><br>
        <span style="font-size: 12px; color: #ccc;">KILLS: <span id="k">0</span> | GOLD: <span id="g">0</span></span>
    </div>
    <div id="cross"></div>
    <div id="fire-btn">FIRE</div>
</div>

<script>
    let scene, camera, renderer, weapon, enemy;
    let yaw = 0, pitch = 0;
    let kills = 0, gold = 0;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);

        camera = new THREE.PerspectiveCamera(65, window.innerWidth/window.innerHeight, 0.01, 1000);
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        // --- МОЩНЫЙ СВЕТ НА ПУШКУ ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambient);
        
        const flashLight = new THREE.PointLight(0xffffff, 1.5, 10);
        camera.add(flashLight); // Свет двигается вместе с камерой

        // Пол
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x555555}));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        loadWeapon();
        spawnEnemy();
        setupControls();
        animate();
    }

    function loadWeapon() {
        const loader = new THREE.GLTFLoader();
        loader.load('./weapon.glb', (gltf) => {
            weapon = gltf.scene;

            // --- КОРРЕКЦИЯ ВИДА "В РУКАХ" ---
            // Позиция: x (вправо), y (вниз), z (глубина)
            weapon.position.set(0.3, -0.3, -0.5); 
            
            // ПОВОРОТ: Исправляем "боковой" вид. 
            // Math.PI / 2 — это поворот на 90 градусов.
            // Если всё равно боком, попробуй поменять на 0 или -Math.PI / 2
            weapon.rotation.set(0, Math.PI / 2, 0); 

            weapon.scale.set(0.3, 0.3, 0.3);

            // Делаем пушку яркой
            weapon.traverse(child => {
                if (child.isMesh) {
                    child.material.metalness = 0.2;
                    child.material.roughness = 0.8;
                }
            });

            camera.add(weapon);
        });
    }

    function spawnEnemy() {
        if(enemy) scene.remove(enemy);
        enemy = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0xff4444}));
        enemy.position.set(Math.random()*20-10, 1, Math.random()*20-10);
        scene.add(enemy);
    }

    function setupControls() {
        let lx, ly;
        window.addEventListener('touchstart', e => { lx = e.touches[0].clientX; ly = e.touches[0].clientY; });
        window.addEventListener('touchmove', e => {
            let dx = (e.touches[0].clientX - lx) * 0.005;
            let dy = (e.touches[0].clientY - ly) * 0.005;
            yaw -= dx; pitch -= dy;
            pitch = Math.max(-1.5, Math.min(1.5, pitch));
            lx = e.touches[0].clientX; ly = e.touches[0].clientY;
        });

        document.getElementById('fire-btn').onclick = () => {
            // Отдача
            if(weapon) {
                weapon.position.z += 0.05;
                setTimeout(() => weapon.position.z -= 0.05, 50);
            }
            // Проверка попадания
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            if(ray.intersectObject(enemy).length > 0) {
                kills++; gold += 10;
                document.getElementById('k').innerText = kills;
                document.getElementById('g').innerText = gold;
                spawnEnemy();
            }
        };
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // Автонаведение (только взгляд)
        if(enemy) {
            const targetPos = new THREE.Vector3();
            enemy.getWorldPosition(targetPos);
            const dir = new THREE.Vector3().subVectors(targetPos, camera.position).normalize();
            yaw += (Math.atan2(-dir.x, -dir.z) - yaw) * 0.1;
            pitch += (Math.asin(dir.y) - pitch) * 0.1;
        }

        camera.rotation.order = 'YXZ';
        camera.rotation.y = yaw;
        camera.rotation.x = pitch;
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>
