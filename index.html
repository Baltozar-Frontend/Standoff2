<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Standoff 2 Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Статистика как в оригинале */
        .stats { position: absolute; top: 20px; left: 20px; background: rgba(15,18,22,0.95); color: white; padding: 12px 20px; border-radius: 8px; border-bottom: 3px solid #ffcc00; pointer-events: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .gold-val { color: #ffcc00; font-weight: bold; }

        /* Кнопка стрельбы */
        #fire-btn { 
            position: absolute; bottom: 40px; right: 40px; width: 100px; height: 100px; 
            background: radial-gradient(circle, #ff4444 0%, #990000 100%);
            border: 5px solid #fff; border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 20px; pointer-events: auto;
            box-shadow: 0 0 20px rgba(255,0,0,0.4); active { transform: scale(0.9); }
        }

        /* Джойстик */
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.4; }

        /* Прицел */
        #crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #00ff00; border-radius: 50%; transform: translate(-50%, -50%); opacity: 0.8; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats">
        <b>ANDREY PRO</b><br>
        <div style="font-size: 13px; margin-top: 5px; opacity: 0.9;">
            GOLD: <span class="gold-val" id="g">0</span> | KILLS: <span id="k">0</span>
        </div>
    </div>
    
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="crosshair"></div>
    <div id="fire-btn">FIRE</div>
</div>

<script>
    let scene, camera, renderer, weapon, enemy;
    let yaw = 0, pitch = 0;
    let moveF = 0, moveS = 0;
    let gold = 0, kills = 0;
    let bobbing = 0; // Для покачивания оружия

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        scene.fog = new THREE.Fog(0x87ceeb, 10, 60);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
        camera.rotation.order = 'YXZ';
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Свет (чтобы пушка была яркой)
        scene.add(new THREE.AmbientLight(0xffffff, 0.9));
        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(10, 20, 10);
        scene.add(sun);

        // Мир
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x444444 }));
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);
        scene.add(new THREE.GridHelper(200, 60, 0x000000, 0x555555));

        loadWeapon();
        spawnEnemy();
        setupControls();
        animate();
    }

    function loadWeapon() {
        const loader = new THREE.GLTFLoader();
        loader.load('./weapon.glb', (gltf) => {
            weapon = gltf.scene;

            // --- КОРРЕКЦИЯ ПОВОРОТА (СТВОЛОМ ВПЕРЕД) ---
            weapon.position.set(0.3, -0.3, -0.45); 
            // Math.PI / 2 разворачивает её на 90 градусов от "бокового" состояния
            weapon.rotation.set(0, Math.PI / 2, 0); 
            weapon.scale.set(0.28, 0.28, 0.28);

            // Освещение модели
            weapon.traverse(n => { if(n.isMesh) { n.material.metalness = 0.5; n.material.roughness = 0.5; } });

            camera.add(weapon);
        });
    }

    function spawnEnemy() {
        if(enemy) scene.remove(enemy);
        enemy = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0xff3333 }));
        enemy.position.set(Math.random()*40-20, 1, Math.random()*40-20);
        scene.add(enemy);
    }

    function setupControls() {
        let lookID = null, lx, ly;

        window.addEventListener('touchstart', e => {
            for(let t of e.changedTouches) {
                if(t.clientX > window.innerWidth/2) { lookID = t.identifier; lx = t.clientX; ly = t.clientY; }
            }
        });

        window.addEventListener('touchmove', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === lookID) {
                    yaw -= (t.clientX - lx) * 0.006;
                    pitch -= (t.clientY - ly) * 0.006;
                    pitch = Math.max(-1.4, Math.min(1.4, pitch));
                    lx = t.clientX; ly = t.clientY;
                }
                if(t.clientX < window.innerWidth/2) {
                    const rect = document.getElementById('joy-base').getBoundingClientRect();
                    const dx = t.clientX - (rect.left + 55), dy = t.clientY - (rect.top + 55);
                    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                    const angle = Math.atan2(dy, dx);
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                    moveF = -Math.sin(angle) * (dist/40);
                    moveS = Math.cos(angle) * (dist/40);
                }
            }
        });

        window.addEventListener('touchend', e => {
            for(let t of e.changedTouches) {
                if(t.identifier === lookID) lookID = null;
                if(t.clientX < window.innerWidth/2) { moveF = 0; moveS = 0; document.getElementById('joy-stick').style.transform = `translate(0,0)`; }
            }
        });

        document.getElementById('fire-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(weapon) {
                weapon.position.z += 0.04; // Отдача
                setTimeout(() => weapon.position.z -= 0.04, 50);
            }
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            if(ray.intersectObject(enemy).length > 0) {
                kills++; gold += 20;
                document.getElementById('k').innerText = kills;
                document.getElementById('g').innerText = gold;
                spawnEnemy();
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);

        // Движение и рост игрока
        const speed = 0.12;
        camera.translateX(moveS * speed);
        camera.translateZ(-moveF * speed);
        camera.position.y = 1.6;

        camera.rotation.y = yaw;
        camera.rotation.x = pitch;

        // Эффект покачивания при ходьбе
        if(weapon && (moveF !== 0 || moveS !== 0)) {
            bobbing += 0.15;
            weapon.position.y = -0.3 + Math.sin(bobbing) * 0.01;
            weapon.position.x = 0.3 + Math.cos(bobbing) * 0.005;
        }

        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>
